<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EICR Voice App</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<!-- PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('Service Worker Registered'))
      .catch(err => console.log('SW registration failed', err));
  }
</script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9fafb; color: #111827; }
  h1 { text-align: center; margin-bottom: 10px; color: #2563eb; }
  .section { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  label { display: block; margin-bottom: 6px; font-weight: bold; }
  input, textarea { width: 95%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; }
  button { padding: 10px 14px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px;}
  .mic { background: #10b981; margin-left: 5px; }
  .checkbox-grid { display: flex; flex-wrap: wrap; }
  .checkbox-grid label { width: 50%; margin-bottom: 5px; }
  #circuits, #observations { margin-top: 10px; }
  canvas { border: 1px solid #ccc; margin-top: 10px; }
</style>
</head>
<body>

<h1>EICR Voice App</h1>

<!-- Client Details -->
<div class="section">
  <h2>Client Details</h2>
  <label>Client Name</label>
  <input id="clientName" placeholder="Client name" /> <button class="mic" onclick="startVoice('clientName')">ðŸŽ¤</button>
  <label>Address</label>
  <input id="clientAddress" placeholder="Client address" /> <button class="mic" onclick="startVoice('clientAddress')">ðŸŽ¤</button>
</div>

<!-- Purpose & Date -->
<div class="section">
  <h2>Purpose & Date</h2>
  <label>Purpose</label>
  <input id="purpose" placeholder="Purpose of report" /> <button class="mic" onclick="startVoice('purpose')">ðŸŽ¤</button>
  <label>Inspection Date</label>
  <input id="inspectionDate" type="date" />
</div>

<!-- Supply Characteristics -->
<div class="section">
  <h2>Supply Characteristics</h2>
  <label>Earthing Arrangement</label>
  <input id="earthing" placeholder="e.g. TN-S, TN-C-S" />
  <label>Main Protective Device</label>
  <input id="device" placeholder="Type & Rating" />
  <label>Ze (Î©)</label>
  <input id="ze" placeholder="External earth fault loop impedance" />
</div>

<!-- Schedule of Inspections -->
<div class="section">
  <h2>Schedule of Inspections</h2>
  <div class="checkbox-grid">
    <label><input type="checkbox" id="inspection1" /> Presence of earthing conductor</label>
    <label><input type="checkbox" id="inspection2" /> Main bonding adequate</label>
    <label><input type="checkbox" id="inspection3" /> Protective devices serviceable</label>
    <label><input type="checkbox" id="inspection4" /> Socket outlets polarity correct</label>
  </div>
</div>

<!-- Schedule of Test Results -->
<div class="section">
  <h2>Schedule of Test Results</h2>
  <button onclick="addCircuit()">+ Add Circuit</button>
  <div id="circuits"></div>
</div>

<!-- Observations -->
<div class="section">
  <h2>Observations & Recommendations</h2>
  <button onclick="addObservation()">+ Add Observation</button>
  <div id="observations"></div>
</div>

<!-- Generic Continuation -->
<div class="section">
  <h2>Generic Continuation (Additional Notes)</h2>
  <textarea id="additionalNotes" placeholder="Enter additional notes here"></textarea>
</div>

<!-- Signature -->
<div class="section">
  <h2>Signature</h2>
  <canvas id="sigCanvas" width="300" height="100"></canvas><br>
  <button onclick="clearSig()">Clear</button>
</div>

<!-- Export -->
<div class="section">
  <h2>Preview & Export</h2>
  <button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
function startVoice(fieldId) {
  if (!('webkitSpeechRecognition' in window)) { alert("Voice recognition not supported"); return; }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-GB';
  recognition.onresult = (event) => { document.getElementById(fieldId).value = event.results[0][0].transcript; };
  recognition.start();
}

function addCircuit() {
  const div = document.createElement('div');
  const id = 'circuit_' + document.querySelectorAll('#circuits input').length;
  div.innerHTML = `<input id="${id}" placeholder="Circuit details" style="width:70%">`;
  document.getElementById('circuits').appendChild(div);
}

function addObservation() {
  const div = document.createElement('div');
  const id = 'observation_' + document.querySelectorAll('#observations input').length;
  div.innerHTML = `<input id="${id}" placeholder="Observation" style="width:70%">`;
  document.getElementById('observations').appendChild(div);
}

const canvas = document.getElementById('sigCanvas');
const ctx = canvas.getContext('2d');
let drawing = false;
canvas.addEventListener('mousedown', () => drawing = true);
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mousemove', draw);
function draw(e) { if (!drawing) return; ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(e.offsetX, e.offsetY, 2, 0, Math.PI * 2); ctx.fill(); }
function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Branding colors
  const primaryColor = '#2563eb'; // Replace later with extracted color

  // Logos
  const myLogo = await loadImage('powerhive-logo.png');
  const napitLogo = await loadImage('napit-logo.png');
  doc.addImage(myLogo, 'PNG', 14, 10, 40, 20);
  doc.addImage(napitLogo, 'PNG', 150, 10, 40, 20);

  doc.setFontSize(18);
  doc.setTextColor(primaryColor);
  doc.text("Electrical Installation Condition Report", 14, 40);

  // Collect Data
  const clientName = document.getElementById('clientName').value;
  const clientAddress = document.getElementById('clientAddress').value;
  const purpose = document.getElementById('purpose').value;
  const date = document.getElementById('inspectionDate').value;
  const earthing = document.getElementById('earthing').value;
  const device = document.getElementById('device').value;
  const ze = document.getElementById('ze').value;
  const additionalNotes = document.getElementById('additionalNotes').value;

  let inspections = [];
  for (let i = 1; i <= 4; i++) {
    inspections.push([`Item ${i}`, document.getElementById('inspection'+i).checked ? 'âœ”' : 'âœ˜']);
  }

  let circuits = [];
  document.querySelectorAll('#circuits input').forEach((i, index) => circuits.push([index+1, i.value]));
  let observations = [];
  document.querySelectorAll('#observations input').forEach((i, index) => observations.push([index+1, i.value]));

  // Tables
  doc.autoTable({ startY: 50, head: [['Field', 'Value']], body: [
    ['Client Name', clientName],
    ['Address', clientAddress],
    ['Purpose', purpose],
    ['Date', date]
  ], theme: 'grid' });

  doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Supply Detail', 'Value']], body: [
    ['Earthing Arrangement', earthing],
    ['Main Protective Device', device],
    ['Ze (Î©)', ze]
  ], theme: 'grid' });

  doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Inspection Item', 'Status']], body: inspections, theme: 'grid' });

  doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['#', 'Circuit Details']], body: circuits.length ? circuits : [['-', 'No circuits']], theme: 'grid' });

  doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['#', 'Observation']], body: observations.length ? observations : [['-', 'No observations']], theme: 'grid' });

  // Add new page for Additional Notes
  doc.addPage();
  doc.setFontSize(16);
  doc.text("Generic Continuation (Additional Notes)", 14, 20);
  doc.setFontSize(12);
  doc.text(additionalNotes || "No additional notes provided.", 14, 30);

  // Signature
  const signatureImage = canvas.toDataURL("image/png");
  doc.text("Declaration:", 14, 60);
  doc.text("I certify that this report is issued in accordance with BS 7671.", 14, 70);
  doc.addImage(signatureImage, 'PNG', 14, 80, 60, 20);
  doc.text("Inspector Signature", 14, 105);

  doc.save("EICR_Report.pdf");
}

function loadImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = url;
    img.onload = () => resolve(img);
  });
}
</script>

</body>
</html>
